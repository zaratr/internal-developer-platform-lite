name: IDP-Lite CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest ruff httpx
          pip install -e .
      
      - name: Lint with ruff
        run: ruff check platform/ tests/
        continue-on-error: true
      
      - name: Run tests
        run: pytest tests/ -v
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Dashboard dependencies
        working-directory: ./dashboard
        run: npm ci
      
      - name: Build Dashboard
        working-directory: ./dashboard
        run: npm run build

  build-api-image:
    name: Build Control Plane API Image
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build API Image
        run: |
          docker build -t idp-lite-api:${{ github.sha }} -f platform/api/Dockerfile .
          docker tag idp-lite-api:${{ github.sha }} idp-lite-api:latest
      
      - name: Save image artifact
        run: |
          docker save idp-lite-api:${{ github.sha }} > api-image.tar
      
      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-image
          path: api-image.tar
          retention-days: 7

  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: build-api-image
    if: github.ref == 'refs/heads/main'
    environment:
      name: dev
      url: https://dev.idp-lite.example.com
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: api-image
      
      - name: Load Docker image
        run: docker load < api-image.tar
      
      - name: Deploy to Dev
        run: |
          echo "ðŸš€ Deploying to Dev environment"
          echo "Image: idp-lite-api:${{ github.sha }}"
          # In real scenario: kubectl apply -f k8s/dev/ or similar
      
      - name: Run smoke tests
        run: |
          echo "âœ… Running smoke tests on Dev"
          # In real scenario: curl health endpoints, run integration tests

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: deploy-dev
    if: github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: https://staging.idp-lite.example.com
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: api-image
      
      - name: Load Docker image
        run: docker load < api-image.tar
      
      - name: Deploy to Staging
        run: |
          echo "ðŸš€ Deploying to Staging environment"
          echo "Image: idp-lite-api:${{ github.sha }}"
          # In real scenario: kubectl apply -f k8s/staging/
      
      - name: Run integration tests
        run: |
          echo "âœ… Running integration tests on Staging"
          # In real scenario: pytest tests/integration/

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://idp-lite.example.com
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: api-image
      
      - name: Load Docker image
        run: docker load < api-image.tar
      
      - name: Tag for production
        run: |
          docker tag idp-lite-api:${{ github.sha }} idp-lite-api:prod-${{ github.sha }}
          docker tag idp-lite-api:${{ github.sha }} idp-lite-api:prod-latest
      
      - name: Deploy to Production
        run: |
          echo "ðŸš€ Deploying to Production environment"
          echo "Image: idp-lite-api:prod-${{ github.sha }}"
          echo "Previous: idp-lite-api:prod-latest (available for rollback)"
          # In real scenario: kubectl apply -f k8s/prod/
      
      - name: Health check
        run: |
          echo "âœ… Production health check passed"
          # In real scenario: curl production health endpoint

  rollback:
    name: Rollback Production
    runs-on: ubuntu-latest
    if: failure() && github.ref == 'refs/heads/main'
    needs: deploy-prod
    
    steps:
      - name: Rollback to previous version
        run: |
          echo "âš ï¸ Rolling back to previous production version"
          echo "Deploying: idp-lite-api:prod-latest"
          # In real scenario: kubectl rollout undo deployment/idp-api
